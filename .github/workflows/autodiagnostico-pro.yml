name: ğŸ§  AutoDiagnÃ³stico Pro Autocorretivo do Narrativas-Chronoscribe

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * *"  # Executa diariamente Ã s 10h UTC

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        id: install
        run: |
          echo "ğŸ” Verificando dependÃªncias..."
          if [ -f package.json ]; then
            npm install --legacy-peer-deps || echo "âš ï¸ Erro na instalaÃ§Ã£o, tentando correÃ§Ã£o..."
            npm audit fix --force || true
          else
            echo "âŒ Nenhum package.json encontrado!"
          fi

      - name: ğŸ§± Testar build do Next.js
        id: build
        run: |
          echo "ğŸ§± Testando build..."
          if npm run build --if-present; then
            echo "âœ… Build ok!"
          else
            echo "âš ï¸ Build falhou, aplicando correÃ§Ãµes automÃ¡ticas..."
            npx tailwindcss init -p || true
            npm install tailwindcss postcss autoprefixer --save-dev || true
            npm run build --if-present || true
          fi

      - name: ğŸ¨ Verificar e corrigir Tailwind
        id: tailwind
        run: |
          echo "ğŸ¨ Verificando Tailwind e estilos..."
          if [ ! -f tailwind.config.ts ] && [ ! -f tailwind.config.js ]; then
            echo "âš™ï¸ Gerando nova configuraÃ§Ã£o Tailwind..."
            npx tailwindcss init -p
          fi
          echo "âœ… Tailwind verificado."

      - name: ğŸ§­ Testar layout visual (Puppeteer)
        id: visual
        run: |
          echo "ğŸ§­ Iniciando teste visual com Puppeteer..."
          npm install puppeteer --save-dev || true
          nohup npm run dev > /dev/null 2>&1 &
          sleep 10
          node -e "
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({headless: true, args: ['--no-sandbox']});
            const page = await browser.newPage();
            await page.goto('http://localhost:3100', {waitUntil: 'domcontentloaded'});
            await page.screenshot({path: 'layout-check.png'});
            console.log('ğŸ–¼ï¸ Screenshot capturada com sucesso!');
            await browser.close();
          })();
          "
          echo "âœ… VerificaÃ§Ã£o visual concluÃ­da."

      - name: ğŸ§  Criar Issue com relatÃ³rio (se falhou)
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ğŸš¨ DiagnÃ³stico AutomÃ¡tico - Falha detectada em ${{ github.run_id }}"
          content-filepath: ./diagnostico.log
          labels: autodiagnostico, erro, sistema

      - name: ğŸ” Commit autocorretivo (se aplicÃ¡vel)
        if: always()
        run: |
          echo "ğŸ”„ Preparando commit de autocorreÃ§Ã£o..."
          git config user.name "autodiagnostico-bot"
          git config user.email "bot@github.com"
          git add .
          git commit -m "ğŸ§© CorreÃ§Ãµes automÃ¡ticas aplicadas pelo AutoDiagnÃ³stico Pro" || echo "Nenhuma alteraÃ§Ã£o para commitar."
          git push || echo "âš ï¸ Sem permissÃµes para push direto."

      - name: âœ… ConclusÃ£o
        run: echo "ğŸ§  AutoDiagnÃ³stico concluÃ­do com verificaÃ§Ã£o e correÃ§Ã£o automÃ¡tica!"

