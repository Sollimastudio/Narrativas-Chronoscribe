name: ðŸ§  AutoDiagnÃ³stico Pro do Narrativas-Chronoscribe

on:
  schedule:
    - cron: "0 10 * * *" # Executa diariamente Ã s 10h UTC
  workflow_dispatch:

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ“¦ Instalar dependÃªncias
        id: install
        run: |
          echo "ðŸ§  Verificando dependÃªncias..."
          if [ -f package.json ]; then
            npm install --legacy-peer-deps || echo "âš ï¸ Erro durante instalaÃ§Ã£o de dependÃªncias"
          else
            echo "âŒ Nenhum package.json encontrado!"
          fi

      - name: ðŸ§ª Testar scripts principais
        id: scripts
        run: |
          echo "ðŸ§  Verificando scripts..."
          if grep -q "\"build\"" package.json; then
            echo "âœ… Script de build encontrado."
          else
            echo "âš ï¸ Script de build nÃ£o encontrado no package.json"
          fi

          if grep -q "\"start\"" package.json; then
            echo "âœ… Script de start encontrado."
          else
            echo "âš ï¸ Script de start nÃ£o encontrado no package.json"
          fi

      - name: ðŸ§± Testar build
        id: build
        run: |
          echo "ðŸ—ï¸ Iniciando build..."
          if npm run build; then
            echo "âœ… Build concluÃ­do com sucesso!"
          else
            echo "âŒ Falha no build."
          fi

      - name: ðŸ§¾ Verificar variÃ¡veis de ambiente
        id: envcheck
        run: |
          echo "ðŸŒ Verificando variÃ¡veis de ambiente..."
          if [ -f .env.local ]; then
            echo "âœ… Arquivo .env.local encontrado."
          else
            echo "âš ï¸ Nenhum arquivo .env.local encontrado!"
          fi

      - name: ðŸ§© Gerar relatÃ³rio
        id: report
        run: |
          echo "ðŸ“Š Gerando relatÃ³rio de diagnÃ³stico..."
          echo "## ðŸ§  DiagnÃ³stico do Narrativas-Chronoscribe" > diagnostico.md
          echo "- Data: $(date)" >> diagnostico.md
          echo "- Branch: $GITHUB_REF_NAME" >> diagnostico.md
          echo "- Commit: $GITHUB_SHA" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "### Logs principais:" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "#### DependÃªncias" >> diagnostico.md
          echo "$(npm list --depth=0 2>/dev/null || echo 'NÃ£o foi possÃ­vel listar dependÃªncias.')" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "#### Ambiente" >> diagnostico.md
          echo "$(ls -1 .env* 2>/dev/null || echo 'Nenhum arquivo .env encontrado.')" >> diagnostico.md

      - name: ðŸª¶ Criar Issue automÃ¡tica
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“‹ DiagnÃ³stico AutomÃ¡tico - ${{ github.run_id }}"
          content-filepath: diagnostico.md
          labels: |
            autodiagnostico
            sistema
          token: ${{ secrets.GH_PERSONAL_TOKEN }}

