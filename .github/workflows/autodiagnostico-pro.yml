name: ğŸ§  AutoDiagnÃ³stico Pro do Narrativas-Chronoscribe

on:
  schedule:
    - cron: "0 10 * * *" # Executa diariamente Ã s 10h UTC
  workflow_dispatch:

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        id: install
        run: |
          echo "ğŸ” Verificando dependÃªncias..."
          if [ -f package.json ]; then
            npm install --legacy-peer-deps || echo "âš ï¸ Erro durante instalaÃ§Ã£o de dependÃªncias"
          else
            echo "ğŸš« Nenhum package.json encontrado!"
          fi

      - name: ğŸ§ª Testar scripts principais
        id: scripts
        run: |
          echo "ğŸ§© Verificando scripts..."
          if grep -q "\"build\"" package.json; then
            echo "âœ… Script de build encontrado."
          else
            echo "âš ï¸ Script de build nÃ£o encontrado no package.json"
          fi
          if grep -q "\"start\"" package.json; then
            echo "âœ… Script de start encontrado."
          else
            echo "âš ï¸ Script de start nÃ£o encontrado no package.json"
          fi

      - name: ğŸ§± Testar build
        id: build
        run: |
          echo "ğŸ—ï¸ Testando build..."
          npm run build || echo "âŒ Erro ao executar o build."

      - name: ğŸ” Verificar variÃ¡veis de ambiente
        id: envcheck
        run: |
          echo "ğŸŒ¿ Verificando variÃ¡veis de ambiente (.env.local)..."
          if [ -f .env.local ]; then
            echo "âœ… Arquivo .env.local encontrado."
            cat .env.local | grep "=" | awk -F= '{print "ğŸ”¸ " $1}' || echo "âš ï¸ Nenhuma variÃ¡vel encontrada"
          else
            echo "ğŸš« Arquivo .env.local nÃ£o encontrado!"
          fi

      - name: ğŸ“Š Gerar relatÃ³rio
        id: relatorio
        run: |
          echo "ğŸ§  RelatÃ³rio de DiagnÃ³stico do Narrativas-Chronoscribe" > diagnostico.md
          echo "Data: $(date)" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "### ğŸ”¹ DependÃªncias:" >> diagnostico.md
          npm list --depth=0 || echo "Erro ao listar dependÃªncias" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "### ğŸ”¹ VerificaÃ§Ã£o de ambiente:" >> diagnostico.md
          if [ -f .env.local ]; then
            echo "âœ… Arquivo .env.local presente." >> diagnostico.md
          else
            echo "âš ï¸ Arquivo .env.local ausente!" >> diagnostico.md
          fi
          echo "" >> diagnostico.md
          echo "### ğŸ”¹ Teste de Build:" >> diagnostico.md
          if npm run build; then
            echo "âœ… Build concluÃ­do com sucesso." >> diagnostico.md
          else
            echo "âŒ Erro durante o build. Veja os logs acima." >> diagnostico.md
          fi

      - name: ğŸª¶ Criar Issue automÃ¡tica
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ğŸ“‹ DiagnÃ³stico AutomÃ¡tico - ${{ github.run_id }}"
          content-filepath: diagnostico.md
          labels: |
            autodiagnostico
            sistema
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… ConclusÃ£o
        run: echo "ğŸ§© AutoDiagnÃ³stico Pro finalizado com sucesso!"

