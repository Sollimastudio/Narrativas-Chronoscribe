name: ğŸ§  AutoDiagnÃ³stico Pro Autocorretivo do Narrativas-Chronoscribe

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * *"  # Executa diariamente Ã s 10h UTC

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        id: install
        run: |
          echo "ğŸ” Verificando dependÃªncias..."
          if [ -f package.json ]; then
            npm install --legacy-peer-deps || echo "âš ï¸ Erro durante instalaÃ§Ã£o, tentando correÃ§Ã£o..."
            npm audit fix --force || true
          else
            echo "âŒ Nenhum package.json encontrado!"
          fi

      - name: ğŸ§ª Testar build e layout
        id: build
        run: |
          echo "ğŸ§± Testando build..."
          if npm run build --if-present; then
            echo "âœ… Build bem-sucedido."
          else
            echo "âš ï¸ Build falhou, tentando correÃ§Ã£o automÃ¡tica de Tailwind e dependÃªncias..."
            npx tailwindcss init -p || true
            npm install tailwindcss postcss autoprefixer --save-dev || true
            npm run build --if-present || true
          fi

      - name: ğŸ¨ Verificar estilos e alinhamento
        id: ui
        run: |
          echo "ğŸ¨ Verificando inconsistÃªncias de Tailwind..."
          if [ -d src/styles ] || [ -f tailwind.config.ts ]; then
            echo "âœ… ConfiguraÃ§Ã£o de estilos detectada."
          else
            echo "âš™ï¸ Restaurando Tailwind padrÃ£o..."
            npx tailwindcss init -p
          fi

      - name: ğŸ§  Criar Issue com relatÃ³rio
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ğŸš¨ DiagnÃ³stico AutomÃ¡tico - Falha detectada em ${{ github.run_id }}"
          content-filepath: ./diagnostico.log
          labels: autodiagnostico, erro, sistema

      - name: ğŸ” Commit autocorretivo (se aplicÃ¡vel)
        if: always()
        run: |
          echo "ğŸ”„ Preparando commit de autocorreÃ§Ã£o..."
          git config user.name "autodiagnostico-bot"
          git config user.email "bot@github.com"
          git add .
          git commit -m "ğŸ§© CorreÃ§Ãµes automÃ¡ticas aplicadas pelo AutoDiagnÃ³stico Pro" || echo "Nenhuma alteraÃ§Ã£o para commitar."
          git push || echo "Sem permissÃµes para push direto."

      - name: âœ… ConclusÃ£o
        run: echo "ğŸ§  AutoDiagnÃ³stico concluÃ­do com verificaÃ§Ã£o e correÃ§Ã£o automÃ¡tica!"


