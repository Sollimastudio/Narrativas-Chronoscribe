name: üß† AutoDiagn√≥stico Pro Autocorretivo do Narrativas-Chronoscribe

on:
  workflow_dispatch:        # ‚úÖ habilita o bot√£o "Run workflow" no GitHub Actions
  schedule:
    - cron: "0 10 * * *"    # executa diariamente √†s 10h UTC

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_DIAGNOSTICO_TOKEN }}

      - name: ‚öôÔ∏è Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üì¶ Instalar depend√™ncias
        run: |
          echo "üîç Verificando depend√™ncias..."
          if [ -f package.json ]; then
            npm install --legacy-peer-deps || echo "‚ö†Ô∏è Erro durante instala√ß√£o de depend√™ncias"
          else
            echo "‚ùå Nenhum package.json encontrado!"
          fi

      - name: üé® Verificar Tailwind config
        run: |
          echo "üé® Verificando Tailwind config..."
          if [ ! -f tailwind.config.js ] && [ -f tailwind.config.ts ]; then
            echo "‚ö° Corrigindo extens√£o do Tailwind (copiando .ts para .js)"
            cp tailwind.config.ts tailwind.config.js
          else
            echo "‚úÖ Tailwind config verificado."
          fi

      - name: üß† Testar build
        run: |
          echo "üèóÔ∏è Testando build..."
          npm run build || echo "‚ùå Falha de build detectada"

      - name: ü©∫ Gerar relat√≥rio de diagn√≥stico
        run: |
          echo "üìä Gerando relat√≥rio..."
          mkdir -p diagnostics
          echo "Relat√≥rio gerado em $(date)" > diagnostics/report-$(date +%F).log
          echo "Verifica√ß√µes do ambiente:" >> diagnostics/report-$(date +%F).log
          node -v >> diagnostics/report-$(date +%F).log
          npm -v >> diagnostics/report-$(date +%F).log
          echo "‚úÖ Diagn√≥stico conclu√≠do com sucesso." >> diagnostics/report-$(date +%F).log

      - name: üõ†Ô∏è Criar Pull Request autom√°tico (se houver corre√ß√µes)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.AUTO_DIAGNOSTICO_TOKEN }}
          branch: "auto-fix/diagnostico-$(date +%s)"
          title: "üß† Corre√ß√µes autom√°ticas do AutoDiagn√≥stico Pro"
          body: |
            Este PR foi gerado automaticamente pelo agente AutoDiagn√≥stico Pro.
            Inclui:
            - Corre√ß√µes Tailwind e build
            - Verifica√ß√£o de depend√™ncias
            - Relat√≥rio de integridade do sistema
          commit-message: "fix: corre√ß√µes autom√°ticas do AutoDiagn√≥stico Pro"
          labels: "autofix, sistema"
          delete-branch: true

      - name: ‚úÖ Conclus√£o
        run: echo "‚úÖ AutoDiagn√≥stico Pro conclu√≠do com sucesso!"

