name: ðŸ¤– AutoDiagnÃ³stico DiÃ¡rio do Narrativas-Chronoscribe

on:
  schedule:
    - cron: "0 10 * * *" # Executa todos os dias Ã s 10h UTC
  workflow_dispatch:      # Permite rodar manualmente tambÃ©m

jobs:
  diagnostico:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          if [ -f package.json ]; then
            echo "ðŸ” Instalando dependÃªncias do projeto..."
            npm install --legacy-peer-deps || echo "âš ï¸ Erro ao instalar dependÃªncias"
          else
            echo "âš ï¸ Nenhum package.json encontrado. Verifique a estrutura do projeto."
          fi

      - name: ðŸ§ª Testar build do projeto
        run: |
          echo "ðŸ—ï¸ Iniciando teste de build..."
          if [ -f package.json ]; then
            npm run build || echo "âŒ Erro ao executar o build do projeto"
          else
            echo "ðŸš« Nenhum build script encontrado no package.json"
          fi

      - name: ðŸ” Verificar arquivos crÃ­ticos
        run: |
          echo "ðŸ§  Verificando arquivos essenciais..."
          for file in ".env.local" "prisma/schema.prisma" "src/app/page.tsx"; do
            if [ -f "$file" ]; then
              echo "âœ… Encontrado: $file"
            else
              echo "âš ï¸ Ausente: $file"
            fi
          done

      - name: ðŸ§¾ Gerar relatÃ³rio de diagnÃ³stico
        id: report
        run: |
          echo "ðŸ“‹ Gerando relatÃ³rio..."
          echo "## ðŸ§  RelatÃ³rio de DiagnÃ³stico - $(date)" > diagnostico.md
          echo "" >> diagnostico.md
          echo "### ðŸ”¹ Projeto:" >> diagnostico.md
          echo "$(basename $(pwd))" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "### ðŸ”¹ Logs resumidos:" >> diagnostico.md
          echo "" >> diagnostico.md
          tail -n 40 $(find . -type f -name "*.log" 2>/dev/null | head -n 1) >> diagnostico.md || echo "Nenhum log encontrado" >> diagnostico.md
          echo "" >> diagnostico.md
          echo "âœ… DiagnÃ³stico concluÃ­do em $(date)" >> diagnostico.md

      - name: ðŸ§¾ Mostrar resultado no console
        run: cat diagnostico.md

      - name: ðŸª¶ Criar Issue automÃ¡tica com resultado
        if: always()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“¡ AutoDiagnÃ³stico - $(date +'%d/%m/%Y %H:%M')"
          content-filepath: diagnostico.md
          labels: |
            autodiagnostico
            agente
          token: ${{ secrets.GITHUB_TOKEN }}

